# Разработка программ в реальном режиме процессора x86
## Теоретические сведения
**Реальный режим процессора**, также известный как "режим реального адреса" (Real Mode), является одним из режимов работы процессора в архитектуре x86. Этот режим был введен в первом 16-битном микропроцессоре Intel 8086 и используется во всех последовательных процессорах семейства x86, включая 80186, 80286, 80386, 80486 и Pentium.

### Основные характеристики режима реального адреса:
1. 20-битная адресация: Процессор в режиме реального адреса использует 20-битную систему адресации, что позволяет обрабатывать до 1 МБ оперативной памяти.
2. Однопотоковость: Процессор в режиме реального адреса обрабатывает только один поток инструкций за раз.
3. Отсутствие защиты и привилегий: Режим реального адреса не предусматривает защиты памяти и привилегированного уровня доступа. Это означает, что любая инструкция может иметь доступ к любому адресу памяти.
4. Ограниченные режимы адресации: В режиме реального адреса доступны только простые режимы адресации, такие как регистровая, непосредственная и регистровая с относительным смещением.
5. Ограниченный размер регистров: Регистры общего назначения процессора имеют размер 16 бит. Адресные регистры, такие как IP (инструкционный указатель) и CS (селектор кода), также имеют размер 16 бит.
6. Работа с сегментным регистром: Режим реального адреса использует сегментный регистр для адресации памяти. Сегментный регистр содержит базовый адрес сегмента, а смещение используется для определения конкретного физического адреса внутри сегмента.

Хотя режим реального адреса является самым старым и простым режимом работы процессора x86, он все еще используется в специализированных системах и утилитах, а также при запуске операционных систем с поддержкой обратной совместимости, таких как DOS и некоторые режимы загрузки BIOS. Однако для большинства современных приложений и операционных систем используется защищенный режим процессора (Protected Mode), который предоставляет более высокий уровень защиты и функциональности.

**Прерывания BIOS (Basic Input/Output System)** являются одним из ключевых механизмов компьютера, выполняющих обработку различных операций в реальном режиме процессора. В реальном режиме процессора, который используется DOS и некоторыми операционными системами, прерывания BIOS позволяют взаимодействовать с аппаратными устройствами и выполнять определенные функции.
Существуют различные типы прерываний BIOS, каждое из которых имеет свою уникальную функцию. Вот некоторые из наиболее распространенных прерываний BIOS в реальном режиме процессора:

**INT 10h**: Это прерывание BIOS используется для работы с графическим режимом. Оно позволяет устанавливать цвета, отображать символы и графику на экране, а также менять разрешение экрана.

**INT 13h**: Это прерывание BIOS предназначено для работы с дисковыми устройствами. Оно позволяет выполнять чтение и запись данных на жесткий диск, флоппи-диск или другие съемные носители.

**INT 16h**: Это прерывание BIOS используется для работы с клавиатурой. Оно позволяет определять нажатие клавиш, считывать и обрабатывать ввод с клавиатуры.

**INT 21h**: Это прерывание BIOS предоставляет различные сервисы операционной системе DOS. Оно позволяет выполнять операции с файлами и папками, выводить данные на экран, читать и записывать данные с консоли и другие операции, связанные с вводом-выводом.

**INT 1Ah**: Это прерывание BIOS предоставляет функции работы с системным таймером. Оно позволяет определять текущее время, измерять промежутки времени и выполнять другие задачи, связанные со временем.

Каждое из этих прерываний BIOS имеет свой номер и соответствующую функцию, которую они выполняют. Для вызова прерывания BIOS в реальном режиме процессора используется команда INT, которая передает управление соответствующей функции BIOS.
Указанные прерывания BIOS являются лишь некоторыми из множества доступных прерываний. Каждый производитель может добавлять собственные прерывания BIOS для поддержки своих устройств или функций.

## Практическая часть
Рассмотрим процесс создания простейшей программы, которая будет взаимодействовать с прерываниями BIOS. 

### Вывод текстовой информации
Выведем на экран один символ.
Для этого создайте файл ```lab1_1.asm``` и вставьте в него следующий фрагмент кода:
``` asm
[BITS 16]	                       
[ORG 0x7C00]	                   

;MOV AL, 0x50              ; Символ 'P' таблицы ASCII	
MOV AL, 'P'                ; Можно писать сразу сам символ			  
MOV AH, 0x0E               ; Вывод символа на экран (AH = 13)                   
MOV BH, 0x00               ; Номер страницы                  
MOV BL, 0x14               ; Цвет (только для графического режима)

INT 0x10	               ; Работа с прерываниями видеоадаптера                       
RET		                           

TIMES 510 - ($ - $$) db 0 ; Заполнение нулями оставшихся байт	       
DW 0xAA55			      ; Указатель на то, что файл является загрузочным          

```

Теперь файл необходимо скомпилировать. Воспользуйтесь командой:

```
nasm.exe lab1_1.asm -o boot.img 
```

Теперь полученный образ можно запустить. Сделать это можно либо с помощью загрузочного носителя, либо при помощи любого средства виртуализации.
Убедитесь, что символ выводится на экран.

## Запуск программ, написанных в RealMode
### С использованием средств виртуализации

#### VirtualBox
Установите средство виртуализации ```Oracle VirtualBox``` (ссылка: https://www.virtualbox.org/) 
Создайте новую виртуальную машину. Выберите семейство ОС Other, тип ОС: Unknown (32-бита). Объём RAM – 32МБ, HDD не требуется. В настройках машины добавьте новый контроллер Floppy и выберите существующий файл boot.img. После внесения настроек нажмите кнопку «Запустить»

#### QEMU
Установите средство виртуализации QEMU (ссылка: https://qemu.weilnetz.de/w64/) 
Перейдите в каталог QEMU и выполните команду:
```
qemu-system-i386.exe C:\nasm\1.img
```

### Запись на загрузочный носитель
Запишите на него файл boot.img любой удобной для этого программой, например, Rufus (ссылка: https://rufus.ie/ru/). Обратите внимание, что подобные программы полностью стирают файловую систему и все данные с накопителя. Без повторного формирования накопитель не будет пригоден для работы с ним. Перезагрузите компьютер, и выберите опцию загрузки USB Device. На новых ПК убедитесь, что включен режим загрузки с совместимостью с BIOS (Legacy mode, CSM mode, BIOS mode и т.д.).


## Запуск с использованием ОС DOS

Операционная система DOS работает в реальном режиме процессора. В те времена, когда она появилась, других режимов процессора и не существовало. Сегодня существуют тысячи модификаций этой ОС, однако все они позволяют запускать программы в реальном режиме. 
Программы для DOS имеют расширение ```.com``` и поддерживают прерывания BIOS.
Рассмотрим отличия программы для DOS от программы загрузочного сектора:

``` asm
[BITS 16]	                       
[ORG 0x100]	                   

MOV AL, 'P'      
MOV AH, 0x0E               
MOV BH, 0x00   
MOV BL, 0x14   

INT 0x10	                      
RET		       
```

Здесь 3 основных отличия:
1. Адрес программы должен начинатся с ```0x100```. Первые ```100h``` байт выделены для хранения служебной информации о программе
2. Нет необходимости в выравнии файла до размера страницы
3. Метка ```0xAA55``` не является обязательной

В остальном программа не будет ничем отличаться от программы-загрузчика

### Использование отладчика DOS

Для удобства отладки программы предлагается использовать возможности программы DOSBox. Это один из самых популярных эмуляторов DOS. 
Чтобы запустить программу в режиме отладки:
1. Скачайте и запустите DOSBox (версия Debug)
2. Подключите к нему каталог с программой как внешний диск
``` 
Z:\> MOUNT C: <путь к каталогу с COM-файлами>
```
3. Запустите программу в режиме отладки
```
C:\> DEBUG <COM-файл>
```

4. Перейдите в окно окладки. В нем можно посмотреть значения системных регистров, оперативной памяти, а также переходить между командами. Для перехода используйте команды "Шаг с обходом" и "Шаг с заходом" (клавиши F10 и F11 соответственно)

### Самостоятельное задание
1. Выведите на экран название университета (RSREU)
2. Реализуйте задание №1 при помощи цикла и символьного массива.
3. Исследуйте возможности отладчика DEBUG в программе DOSBox
